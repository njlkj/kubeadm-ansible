---
- name: Check if kubelet running
  shell: "systemctl status kubelet.service|grep Active"
  register: kubelet_status

- block:

  - name: Get ca cert hash
    shell: openssl x509 -pubkey -in {{ certificates_dir }}/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* /sha256:/'
    delegate_to: "{{ groups.master.0 }}"
    register: caCertHashes
    run_once: yes
    changed_when: false

  - set_fact: caCertHashes={{ caCertHashes.stdout }}
    run_once: yes

  - name: Join to cluster if needed
    include_tasks: join.yml

  - name: Enable and check kubelet service
    systemd:
      name: kubelet
      daemon_reload: yes
      state: started
      enabled: yes

  when: '"running" not in kubelet_status.stdout'